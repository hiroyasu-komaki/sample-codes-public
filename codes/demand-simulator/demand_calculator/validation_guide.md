# データバリデーション機能 - 使用ガイド

## 概要

data_validator.py は、IT人材需要計算プログラムの入力CSVファイルの品質をチェックするモジュールです。
処理を実行する前に、データの構造、形式、論理的な整合性を検証し、エラーや警告を報告します。

## 実行タイミング

バリデーションは以下のタイミングで自動的に実行されます：

- **ステップ1を実行する前**（CSVフォルダのファイルを検証）
- **全ステップ実行を選択した場合**（ステップ1の前に自動実行）

ステップ2のみを実行する場合は、中間ファイルを対象とするため、バリデーションはスキップされます。

## 検証内容

### 0. 設定ファイルチェック（NEW）

処理実行前に、設定ファイル（calc_assumptions.yaml）をチェックします：

- ✅ ファイルの存在と読み込み可能性
- ✅ ゼロ除算を引き起こす設定値の検出
  - `investment_to_person_months.average_unit_cost` がゼロまたは負でないこと
  - `investment_to_person_months.in_house_ratio` が1.0未満であること（100%内製は不可）
  - `operation_parameters.average_unit_cost` がゼロまたは負でないこと

### 1. ファイル構造チェック

- ✅ ファイルの存在確認
- ✅ ファイルサイズの妥当性
- ✅ エンコーディング（UTF-8推奨、Shift-JISも対応）
- ✅ CSVの読み込み可能性
- ✅ データ件数（空でないこと）
- ✅ 重複する列名の検出
- ✅ 完全に空の行の検出

### 2. 必須列チェック

必須列が存在するかをチェックします：

- `案件ID`
- `案件名`
- `初期投資金額`
- `運用費`
- `システム利用開始時期`

### 3. 推奨列チェック（警告のみ）

推奨列が存在するかをチェックします（なくても処理は続行可能）：

- `活動開始月`
- `活動終了月`

### 4. 必須項目の値チェック

- ✅ 必須列に欠損値（空セル）がないこと
- ✅ 必須列に空文字列がないこと

### 5. 数値列のチェック

#### 初期投資金額
- 数値に変換可能であること
- **0円より大きいこと（ゼロは処理エラーの原因となるため禁止）**
- 負の値でないこと
- 1,000億円以下であること（超える場合は警告）

#### 運用費
- 数値に変換可能であること
- 0円以上であること（ゼロは許可）
- 負の値でないこと
- 100億円以下であること（超える場合は警告）

### 6. 日付列のチェック

以下の形式をサポート：
- `YYYY/MM/DD` (例: 2025/04/01)
- `YYYY-MM-DD` (例: 2025-04-01)
- `YYYY/MM` (例: 2025/04)
- `YYYY-MM` (例: 2025-04)

チェック内容：
- ✅ 日付形式の妥当性
- ✅ 2000年以降の日付であること（それ以前は警告）
- ✅ 未来の日付（必要に応じて許可）

### 7. テキスト列のチェック

#### 案件ID
- 重複がないこと（重複はエラー）
- 100文字以内であること（超える場合は警告）
- 制御文字が含まれていないこと

#### 案件名
- 200文字以内であること（超える場合は警告）
- 制御文字が含まれていないこと

### 8. 論理整合性チェック

- ✅ 活動開始月 ≦ 活動終了月
- ✅ **活動期間が1ヶ月以上であること（0ヶ月はゼロ除算の原因）**
- ✅ 活動期間が60ヶ月（5年）以内であること（超える場合は警告）
- ✅ システム利用開始時期と活動終了月の関係性

### 9. データ品質チェック

- ✅ 案件名に一般的なキーワード（開発、構築、導入等）が含まれること
  - 20%以上の行にキーワードがない場合は警告
- ✅ 運用費が初期投資の10倍以内であること（超える場合は警告）

## エラーと警告の違い

### エラー (ERROR)
処理を続行できない重大な問題です。エラーがある場合、プログラムは処理を中断します。

**例：**
- 必須列が存在しない
- 必須項目が空
- 案件IDが重複している
- 数値列に数値でない値がある
- 日付形式が不正
- 活動開始月が終了月より後

### 警告 (WARNING)
処理は続行可能ですが、データ品質や結果精度に影響する可能性がある問題です。

**例：**
- 推奨列が存在しない
- 数値が異常に大きい・小さい
- 日付が過去すぎる
- テキストが長すぎる
- データ整合性に疑問がある

## 出力フォーマット

```
================================================================================
データバリデーション: sample_data.csv
================================================================================

[検証内容の詳細]

================================================================================
バリデーション結果
================================================================================

❌ エラー: 3件
--------------------------------------------------------------------------------
  [ERROR] 必須列: 必須列が見つかりません: 初期投資金額
  [ERROR] 必須項目: [行 5][案件名列] 必須項目が空です
  [ERROR] データ整合性: [行 12] 活動開始月が終了月より後です: 2025/06 > 2025/03

⚠️  警告: 2件
--------------------------------------------------------------------------------
  [WARNING] 推奨列: 推奨列が見つかりません: 活動開始月（デフォルト値が使用されます）
  [WARNING] 値範囲: [行 8][初期投資金額列] 値が異常に大きいです: 50,000,000

================================================================================
❌ バリデーション失敗: 処理を続行できません
上記のエラーを修正してから再実行してください。
================================================================================
```

## 使用方法

### 通常の使用（main.pyから自動実行）

```bash
python main.py
```

プログラムを起動すると、ステップ選択の前に自動的にバリデーションが実行されます。

### スタンドアロンでの使用

バリデーション機能だけを使いたい場合：

```python
from modules.data_validator import DataValidator
from pathlib import Path

validator = DataValidator()

# 単一ファイルの検証
is_valid, df = validator.validate_csv_file(Path('CSV/sample.csv'))

if is_valid:
    print("検証成功")
else:
    print("検証失敗")

# 複数ファイルの検証
csv_files = list(Path('CSV').glob('*.csv'))
all_valid = validator.validate_multiple_files(csv_files)
```

## よくあるエラーと対処法

### エラー: 必須列が見つかりません

**原因:** CSVファイルのヘッダー行に必須列名が存在しない

**対処法:**
- 列名のスペルを確認
- 全角・半角の違いを確認
- 余分な空白がないか確認

### エラー: 案件IDが重複しています

**原因:** 同じ案件IDが複数行に存在する

**対処法:**
- 各案件に一意のIDを付与
- 既存IDを修正して重複を解消

### エラー: 必須項目が空です

**原因:** 必須列のセルが空白

**対処法:**
- 空白セルに適切な値を入力
- データソースから欠損値を補完

### エラー: 値がゼロです（ゼロ除算の原因となるため処理できません）

**原因:** 初期投資金額がゼロ

**対処法:**
- 初期投資金額に正の値を入力
- プロジェクトの実態に合わせて金額を設定
- 不明な場合は最小値（例：1千円）を設定

### エラー: 活動期間が0ヶ月以下です

**原因:** 活動開始月と終了月が同じ、または逆転している

**対処法:**
- 活動期間を最低1ヶ月以上に設定
- 開始月と終了月の入力を確認
- 同月に開始・終了する場合でも開始月≠終了月となるように設定

### エラー: 設定ファイルの値がゼロまたは不正です

**原因:** calc_assumptions.yamlの設定値に問題がある

**対処法:**
- `average_unit_cost` がゼロまたは負になっていないか確認
- `in_house_ratio` が1.0以上になっていないか確認（1.0未満に設定）
- 設定ファイルを正しい値に修正

### エラー: 数値に変換できません

**原因:** 数値列に文字列や不正な値が含まれる

**対処法:**
- 数値以外の文字（カンマ、円マーク等）を削除
- 全角数字を半角に変換
- セル内の余分な空白を削除

### エラー: 日付フォーマットが不正です

**原因:** 日付列の形式が推奨フォーマットと異なる

**対処法:**
- YYYY/MM/DD または YYYY-MM-DD 形式に統一
- Excelの日付シリアル値になっている場合は文字列に変換

### 警告: 値が異常に大きいです

**原因:** 数値が通常の範囲を大きく超えている

**対処法:**
- 単位の間違い（例：円で入力すべきところを千円単位で入力）
- 数値の桁数を確認
- 意図的に大きい値の場合は警告を無視して続行可能

## トラブルシューティング

### バリデーションが厳しすぎる場合

data_validator.py の定数を調整できます：

```python
# 数値範囲の調整
NUMERIC_COLUMNS = {
    '初期投資金額': {
        'min': 0,
        'max': 200000000,  # 上限を2000億円に変更
        'allow_zero': False
    }
}

# 日付形式の追加
DATE_COLUMNS = {
    'システム利用開始時期': {
        'formats': ['%Y/%m/%d', '%Y-%m-%d', '%Y年%m月%d日'],  # 和暦を追加
        'allow_future': True
    }
}
```

### エンコーディング問題

UTF-8とShift-JISの両方に対応していますが、その他のエンコーディングの場合：

```python
# data_validator.py の _validate_csv_file メソッドを修正
df = pd.read_csv(file_path, encoding='your-encoding')
```

## 推奨事項

1. **データ入力時の注意**
   - Excelでデータを作成する場合、CSV保存時にUTF-8を選択
   - 数値列には数値のみを入力（カンマ・円マーク不要）
   - 日付は統一フォーマットで入力

2. **定期的なチェック**
   - データ更新後は必ずバリデーションを実行
   - 警告が多い場合はデータ入力ルールを見直し

3. **エラーログの保存**
   - バリデーション結果をスクリーンショットまたはテキストで保存
   - データ修正の参考として活用

## まとめ

データバリデーション機能により：
- ✅ データ品質の問題を事前に検出
- ✅ 処理失敗のリスクを低減
- ✅ 計算結果の精度を向上
- ✅ データ入力ミスを早期発見

バリデーション結果を確認し、エラーを修正することで、
より信頼性の高いIT人材需要計算を実現できます。
