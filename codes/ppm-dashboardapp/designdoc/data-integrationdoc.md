# Power BI → GitHub データ連携 完全ガイド（簡潔版）

## 目次
1. [システム全体像](#システム全体像)
2. [基本4方法の比較](#基本4方法の比較)
3. [実際の要件](#実際の要件)
4. [実装方針](#3つの実装方針)
5. [APPENDIX](#APPENDIX)

<br>

## システム全体像

### 要件
- Tagetikから出力されたデータ（Excel/CSV）がSharePointに格納
- Power BIでデータを可視化
- **Power BI上でユーザーがデータ編集（Writeback機能）**
- 編集後のデータを複数ソースから統合
- JSON形式に変換してGitHub Enterpriseへ保存

### データフロー
```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  📊 データソース層                                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        ┌─────────────────────┐
        │   Tagetik.          │
        │   Excel/CSV.        │
        └──────────┬──────────┘
                   ↓
        ┌──────────────────────┐
        │  SharePoint          │
        │  Excel/CSVファイル保存 │
        └──────────┬───────────┘
                   ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  📈 可視化・編集層                                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
   ┌──────────────┬──────────────┬──────────────┐
   │ Power BI #1  │ Power BI #2  │ Power BI #3  │
   │ (JP)         │ (NA)         │ (EMEA)       │
   └──────┬───────┴──────┬───────┴──────┬───────┘
          ↓ ✏️           ↓ ✏️           ↓ ✏️
   ┌──────────────┬──────────────┬──────────────┐
   │ Write Back #1│ Write Back #2│ Write Back #3│
   │ (JP)         │ (NA)         │ (EMEA)       │
   └──────┬───────┴──────┬───────┴──────┬───────┘
          ↓              ↓              ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  💾 データ保存層.                                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
   ┌──────────────┬──────────────┬──────────────┐
   │ SharePoint   │ SharePoint   │ SharePoint   │
   │ List #1      │ List #2      │ List #3.     │
   └──────┬───────┴──────┬───────┴──────┬───────┘
          └──────────────┴──────────────┘
                        ↓
                  ⚡ トリガー発火
                        ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  🔄 オーケストレーション層                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
              ┌─────────────────────┐
              │ Power Automate      │
              └──────────┬──────────┘
                         ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ⚙️  ビジネスロジック処理層 ★重要★                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┌─────────────────────────────────┐
      │   Azure Functions / Logic Apps  │
      ├─────────────────────────────────┤
      │  📥 1. 複数リストからデータ取得     │
      │     List#1: 100件               │
      │     List#2: 150件               │
      │     List#3: 80件                │
      ├─────────────────────────────────┤
      │  🔀 2. データ統合・マージ          │
      │     重複除去: ProductIDで統合      │
      │     合計: 330件 → 250件           │
      ├─────────────────────────────────┤
      │  🧮 3. ビジネスロジック適用        │
      │     ✓ 西暦 → 和暦変換             │
      │     ✓ 差異計算 (実績-予算)         │
      │     ✓ ステータス判定               │
      │     ✓ 達成率算出                  │
      ├─────────────────────────────────┤
      │  📦 4. JSON生成                  │
      │     {                            │
      │       "data": [...250件],        │
      │       "summary": {...}          │
      │     }                           │
      └──────────────┬──────────────────┘
                     ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  🗄️  データ保存層                                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
              ┌─────────────────────┐
              │ GitHub Enterprise   │
              │ 📄 ********.json    │
              └─────────────────────┘
                     ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  🌏  プレゼンテーション（エンドポイント）層             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
              ┌─────────────────────┐
              │ GitHub Pages.       │
              │ 📄 ********.html    │
              └─────────────────────┘
                     ↓
              ・Webアプリケーション
              ・他システムへの連携可能
              ・社内ネットワーク限定
```

<br>

## 基本4方法の比較

GitHubのJSONファイルを更新する基本的な4つの方法

### 方法1: GitHub API直接使用

**概要**: Power AutomateのHTTPアクションでGitHub APIを直接呼び出し

**手順**:
1. Personal Access Token (PAT) 作成
2. HTTPアクションでGET（現在のファイル情報取得）
3. Base64デコード → JSON解析 → データ更新
4. Base64エンコード
5. HTTPアクションでPUT（ファイル更新）

**Pros**:
- ✅ 追加コスト不要
- ✅ GitHub APIの全機能利用可能
- ✅ GitHub Enterprise対応

**Cons**:
- ❌ Base64変換が必要
- ❌ SHA管理が必要
- ❌ エラーハンドリング自前実装

---

### 方法2: GitHubコネクタ使用

**概要**: Power Automateの標準GitHubコネクタを使用

**手順**:
1. GitHub接続作成（PAT使用）
2. 「Create or update file content」アクション
3. リポジトリ、ファイルパス、内容を指定

**Pros**:
- ✅ 設定が簡単（GUI操作のみ）
- ✅ Base64変換不要
- ✅ 直感的

**Cons**:
- ❌ GitHub Enterprise対応が限定的
- ❌ 機能制限あり
- ❌ カスタマイズ性低

---

### 方法3: Azure Logic Apps使用

**概要**: Power AutomateからLogic Appsを呼び出し、Logic AppsがGitHub連携

**手順**:
1. Azure Key VaultにPAT保存
2. Logic App作成（HTTP受信トリガー）
3. マネージドIDでKey Vaultからトークン取得
4. GitHub API呼び出し
5. Power AutomateからLogic Appを呼び出し

**Pros**:
- ✅ エンタープライズグレード
- ✅ 強力なエラーハンドリング
- ✅ Azure Monitorで監視可能
- ✅ セキュリティ強化（Key Vault、Managed ID）

**Cons**:
- ❌ 従量課金コストが発生
- ❌ 設定が複雑
- ❌ Azureサブスクリプション必須

---

### 方法4: Azure Functions使用

**概要**: Azure Functionsでカスタムロジックを実装

**手順**:
1. Azure Functions開発（C#/Python）
2. カスタムロジック実装（データ取得、変換、GitHub更新）
3. Azureへデプロイ
4. Power AutomateからHTTPで呼び出し

**Pros**:
- ✅ 最高の柔軟性
- ✅ 複雑なロジック実装可能
- ✅ 高パフォーマンス
- ✅ テスト・デバッグ容易
- ✅ バージョン管理可能

**Cons**:
- ❌ 開発スキル必要
- ❌ 初期開発工数大
- ❌ 従量課金コスト

---

### 4方法の比較表

| 項目 | 方法1: API直接 | 方法2: コネクタ | 方法3: Logic Apps | 方法4: Functions |
|------|---------------|----------------|------------------|-----------------|
| **難易度** | 中 | 低 | 高 | 最高 |
| **コーディング** | 不要 | 不要 | 不要 | 必要 |
| **Base64処理** | 手動 | 自動 | 手動 | 手動 |
| **柔軟性** | 高 | 低 | 高 | 最高 |
| **保守性** | 中 | 高 | 中 | 低（要スキル）|
| **GitHub Enterprise** | ◎ | △ | ◎ | ◎ |
---

### 選択ガイド

| 選択基準 | 方法1 | 方法2 | 方法3 | 方法4 |
|---------|------|------|------|------|
| 簡単・すぐ始める | ✓ | ✓ | - | - |
| ノーコード | ✓ | ✓ | ✓ | - |
| エンタープライズ要件 | - | - | ✓ | - |
| 複雑なロジック | - | - | - | ✓ |

<br>

## 基本4方法だけでは不十分

### 基本4方法の前提条件

方法1〜4は、**すでにJSONデータが準備されている前提**での「GitHub更新方法」です。

つまり：
- JSONファイルが既に存在する
- 更新するデータが単一ソース
- ビジネスロジックが不要またはシンプル

### 実際の要件はより複雑

実際の要件は：

```
❌ 単純なJSON更新だけではない
✅ 複数のPower BIからWritebackされたデータを統合
✅ 複数のSharePointリストから取得
✅ 和暦変換などの複雑なビジネスロジック適用
✅ 最終的に1つのJSONファイルに統合してGitHub更新
```

### 構成要素の組み合わせが必要

したがって、実装には以下の**組み合わせ**が必要です：

```
[データ収集]
Power BI Writeback → SharePointリスト保存
         ↓
[データ統合・加工] ← ★ここが新たに必要
複数ソースから取得 + ビジネスロジック + JSON生成
         ↓
[GitHub更新]
方法1〜4のいずれかを使用
```

**つまり**：
- **基本4方法** = GitHubへの「書き込み方法」の選択肢
- **方針A/B/C** = 要件全体に対する「システム構成」の選択肢を考察

次のセクションから、実際の要件に合わせた「方針A/B/C」を解説します。

<br>

## 実際の要件

### システム構成

```
┌────────────────────────────────────────┐
│ Power BI レポート #1, #2, #3          │
│ （ユーザーがWritebackで編集）         │
└──────────┬─────────────────────────────┘
           ↓
┌────────────────────────────────────────┐
│ Power Automate（Writebackフロー）     │
│ Power BIボタンから呼び出される        │
└──────────┬─────────────────────────────┘
           ↓
┌────────────────────────────────────────┐
│ SharePoint リスト #1, #2, #3          │
│ 編集データを保存                      │
└──────────┬─────────────────────────────┘
           ↓（トリガー）
┌────────────────────────────────────────┐
│ Power Automate（統合フロー）          │
│ または                                │
│ Azure Functions                       │
└──────────┬─────────────────────────────┘
           ↓
┌────────────────────────────────────────┐
│ データ統合・ビジネスロジック適用      │
│ ・複数リストからデータ取得            │
│ ・データ統合・マージ                  │
│ ・和暦変換などのビジネスロジック      │
│ ・JSON生成                            │
└──────────┬─────────────────────────────┘
           ↓
┌────────────────────────────────────────┐
│ GitHub Enterprise                     │
│ JSONファイルとして保存                │
└────────────────────────────────────────┘
```

### SharePointリスト設計例

各Power BIレポートに対応するSharePointリストを作成

**列構成例**:
- タイトル（既定）
- ProductID（1行テキスト）
- ProductName（1行テキスト）
- Budget（数値）
- Sales（数値）
- UpdatedDate（日付と時刻）
- UpdatedBy（ユーザー）

<br>

## 3つの実装方針

### **方針A: Azure Functions フル活用**

```
Power Automate（最小限）
    ↓
Azure Functions（全処理）
    ├─ SharePointデータ取得
    ├─ データ統合
    ├─ ビジネスロジック
    ├─ JSON生成
    └─ GitHub更新
```

**メリット**:
- ✅ 全処理が1箇所に集約
- ✅ 最高のパフォーマンス
- ✅ テスト・デバッグ容易
- ✅ 将来の拡張が容易

**デメリット**:
- ❌ 開発スキル必要（C#/Python）
- ❌ 初期開発工数5-6日

---

### **方針B: ハイブリッド（Logic Apps + Functions）**

```
Power Automate（トリガー）
    ↓
Logic Apps（データ取得・GitHub更新）
    ↓
Azure Functions（ビジネスロジックのみ）
```

**メリット**:
- ✅ データ取得はノーコード
- ✅ 複雑ロジックのみコード化
- ✅ 段階的実装可能

**デメリット**:
- ❌ 構成が複雑（2サービス管理）
- ❌ コスト若干高い

---

### **方針C: Power Automateのみ**

```
Power Automate（全処理）
    ├─ 複数SharePointリスト取得
    ├─ Apply to eachで統合
    ├─ 変数で和暦変換（困難）
    ├─ JSON作成
    └─ GitHub更新
```

**メリット**:
- ✅ 追加コスト¥0

**デメリット**:
- ❌ 実装が非常に複雑
- ❌ メンテナンス困難
- ❌ パフォーマンス悪い
- ❌ 拡張困難

<br>

### 比較表

| 項目 | 方針A: Functions | 方針B: ハイブリッド | 方針C: PAのみ |
|------|-----------------|-------------------|--------------|
| **複雑ロジック** | ◎ | ○ | △ |
| **複数ソース統合** | ◎ | ○ | △ |
| **パフォーマンス** | ◎ | ○ | △ |
| **保守性** | ◎ | △ | × |
| **スキル要件** | 高 | 中 | 低 |
---

<br>

## APPENDIX

### 要件に最適な構成

```
Power BI #1, #2, #3（Writeback）
    ↓
SharePointリスト #1, #2, #3
    ↓
Power Automate（軽量・トリガーのみ）
    ↓
Azure Functions ★メイン処理
    ├─ 複数SharePointリストからデータ取得
    ├─ データ統合（ProductIDでマージ）
    ├─ ビジネスロジック適用
    │  ├─ 西暦→和暦変換
    │  ├─ 差異計算
    │  ├─ ステータス判定
    │  └─ その他計算処理
    ├─ JSON生成
    └─ GitHub更新
    ↓
GitHub Enterprise
```

### なぜAzure Functions？

**理由**:
1. **複数データソース統合**: 3つ以上のSharePointリストから取得して統合
2. **複雑なビジネスロジック**: 和暦変換、計算処理など
3. **保守性**: コードでバージョン管理、テスト可能
4. **パフォーマンス**: 大量データでも高速処理
5. **拡張性**: 将来の要件変更に対応しやすい
